<html>
<head>
<title>Daynight Map and Clock</title>
<script src = "vector.js"></script>
<script src = "vectorutils.js"></script>
<script src = "map.js"></script>
<script src = "sun.js"></script>
</head>
<body>

<svg width="1000" height="1000" id = "mainplot">

</svg>

<div>
    <h2>Today's Day Length</h2>
    <p><span id = "dayLengthHour">--</span> Hours, <span id = "dayLengthMinute">--</span> Minutes</p>
</div>


<script>
var map = new Map("mainplot", document, window)
var now = new Date(Date.now())
var sun = new Sun(now)
const mapRenderedEvent = new Event('mapRendered')
const landData = new Request("ne_110m_land.json")
const lakeData = new Request("ne_110m_lakes.json")
const borderData = new Request("ne_110m_admin_0_boundary_lines_land.json")

fetch(landData).then((response) =>
	response.json()
).then((lands) => {
	plotLand(lands)
})

function plotLake(lakes) {
	for (var i = 0; i < lakes.features.length; i++) {
		map.plotGeometry(lakes.features[i].geometry.coordinates[0], color = "#0088FF")
	}
	document.dispatchEvent(mapRenderedEvent)
}

/*function plotBorders(borders) {
	for (var i = 0; i < borders.features.length; i++) {
		map.plotLine(borders.features[i].geometry.coordinates, color = "#000000")
	}
	document.dispatchEvent(mapRenderedEvent)
}*/

function plotLand(lands) {
	for (var i = 0; i < lands.features.length; i++) {
		map.plotGeometry(lands.features[i].geometry.coordinates[0])
	}
	fetch(lakeData).then((response) =>
		response.json()
	).then((lakes) => {
		plotLake(lakes)
	})
}

function updateSun() {
	sun.setDate(new Date(Date.now()))
	map.setMarker(sun.longitude, sun.latitude, "#FFFF00", "sun")
	shadowGeometry = Shadow.getShadowPolygon(sun, map)
	map.plotXYGeometry(shadowGeometry, color = "#000000", opacity = "50%", "shadow")
}

document.addEventListener("mapRendered", (e) => {
	updateSun()
	setInterval(updateSun, 60000)
})

var minutes = now.getTimezoneOffset()
var roughDegrees = minutes * 0.25
map.setRotate(-roughDegrees)

navigator.geolocation.getCurrentPosition((position) => {
	let longitudeR = VectorUtils.degreeToRadian(position.coords.longitude)
	let latitudeR = VectorUtils.degreeToRadian(position.coords.latitude)
	map.setMarker(longitudeR, latitudeR, "#FF0000", "user")
	map.setRotate(position.coords.longitude)
	let dayArcLength = Shadow.getDayArcLength(sun, map, VectorUtils.degreeToRadian(39))
	let dayHours = 24 * dayArcLength
	let dayMinutes = (dayHours - Math.floor(dayHours)) * 60
	document.getElementById("dayLengthHour").innerText = Math.floor(dayHours)
	document.getElementById("dayLengthMinute").innerText = Math.floor(dayMinutes)
});

</script>

</body>
</html>