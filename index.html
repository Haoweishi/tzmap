<html>
<head>
    <title>Daynight Map and Clock</title>
    <script src = "vector.js"></script>
    <script src = "vectorutils.js"></script>
    <script src = "map.js"></script>
    <script src = "sun.js"></script>
    <script src = "mapsystem.js"></script>
    <script src = "hourdial.js"></script>
</head>
<body>

<svg width = "1000" height = "1000" id = "mapInterface">
    <g id = "map"></g>
    <image href="clockradial.svg" id = "radial"></image>
    <image href="hourMarker.svg" id = "currentHRMarker"></image>
</svg>

<div>
    <h2>Sunrise</h2>
    <p><span id = "sunriseHour">--</span>:<span id = "sunriseMinute">--</span></p>
    <h2>Sunset</h2>
    <p><span id = "sunsetHour">--</span>:<span id = "sunsetMinute">--</span></p>
</div>


<script>
var map = new MapSystem("mapInterface", window)
var now = new Date()

const mapRenderedEvent = new Event('mapRendered')
const landData = new Request("ne_110m_land.json")
const lakeData = new Request("ne_110m_lakes.json")

fetch(landData).then((response) =>
	response.json()
).then((lands) => {
	plotLand(lands)
})

function plotLake(lakes) {
	for (var i = 0; i < lakes.features.length; i++) {
		map.map.plotGeometry(lakes.features[i].geometry.coordinates[0], color = "#0088FF")
	}
	document.dispatchEvent(mapRenderedEvent)
}

function plotLand(lands) {
	for (var i = 0; i < lands.features.length; i++) {
		map.map.plotGeometry(lands.features[i].geometry.coordinates[0])
	}
	fetch(lakeData).then((response) =>
		response.json()
	).then((lakes) => {
		plotLake(lakes)
	})
}

function setMapTime() {
    now = new Date(Date.now())
    map.setTime(now)
}

document.addEventListener("mapRendered", (e) => {
    now = new Date(Date.now())
	setMapTime(now)
	setInterval(setMapTime, 60000)
})

var minutes = now.getTimezoneOffset()
var roughDegrees = minutes * 0.25
map.map.setRotate(-roughDegrees)


navigator.geolocation.getCurrentPosition((position) => {
	let longitudeR = VectorUtils.degreeToRadian(position.coords.longitude)
	let latitudeR = VectorUtils.degreeToRadian(position.coords.latitude)
	map.map.setMarker(longitudeR, latitudeR, "#FF0000", "user")
	map.map.setRotate(position.coords.longitude)
	let dayArcLength = Shadow.getDayArcLength(map.sun, map.map, latitudeR)
	let dayHours = 24 * dayArcLength
	console.log(dayHours)
	let dayMinutes = (dayHours - Math.floor(dayHours)) * 60

    let noonOffset = Shadow.getSolarNoonOffset(longitudeR)
	var noonDate = new Date(Date.now())
	noonDate.setUTCHours(0)
	noonDate.setUTCMinutes(0)
	var localNoonDate = new Date(noonDate.getTime() + noonOffset*1000)

    let dayMilliSeconds = dayHours * 60 * 60 * 1000
    let sunriseDate = new Date(localNoonDate.getTime() - dayMilliSeconds / 2)
    let sunsetDate = new Date(localNoonDate.getTime() + dayMilliSeconds / 2)
    document.getElementById("sunriseHour").innerText = sunriseDate.getHours()
	document.getElementById("sunriseMinute").innerText = sunriseDate.getMinutes()
	document.getElementById("sunsetHour").innerText = sunsetDate.getHours()
	document.getElementById("sunsetMinute").innerText = sunsetDate.getMinutes()
});

</script>

</body>
</html>